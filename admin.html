<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BookBook Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen p-6">

  <div class="max-w-3xl mx-auto bg-white rounded-2xl shadow-md p-6 space-y-6">
    <h1 class="text-3xl font-bold text-center mb-4">ðŸ“š BookBook Admin Panel</h1>

    <!-- Admin Login -->
    <div id="loginPanel" class="space-y-4">
      <label class="block">
        <span class="text-gray-700">Admin Password:</span>
        <input type="password" id="adminPassword" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2">
      </label>
      <button id="loginBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Login</button>
    </div>

    <!-- Admin Controls -->
    <div id="adminPanel" class="hidden space-y-6">

      <!-- Toggle Voting -->
      <div class="flex items-center justify-between">
        <span class="text-lg font-semibold">Voting Status:</span>
        <div>
          <span id="votingStatusText" class="font-mono text-indigo-600"></span>
          <button id="toggleVotingBtn" class="ml-3 bg-gray-200 hover:bg-gray-300 text-sm px-3 py-1 rounded">Toggle</button>
        </div>
      </div>

      <hr>

      <!-- Add Book -->
      <div class="space-y-2">
        <h2 class="text-xl font-semibold">Add a New Book</h2>
        <div class="flex gap-2">
          <input id="newBookTitle" type="text" placeholder="Enter book title" class="flex-1 rounded border-gray-300 p-2">
          <button id="addBookBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Add</button>
        </div>
        <ul id="bookList" class="list-disc pl-6 text-gray-700"></ul>
      </div>

      <hr>

      <!-- Results -->
      <div>
        <h2 class="text-xl font-semibold mb-2">Voting Results</h2>
        <table class="min-w-full text-left border border-gray-200 rounded-lg">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-3 py-2">Book</th>
              <th class="px-3 py-2">Points</th>
              <th class="px-3 py-2">Voters (Priority)</th>
            </tr>
          </thead>
          <tbody id="resultsTable"></tbody>
        </table>
      </div>

      <hr>

      <!-- Export Votes -->
      <button id="exportBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Export Votes (JSON)</button>
    </div>
  </div>

  <script>
    const API_BASE = "https://bookbook-1vj9.onrender.com"; // â† change if needed
    let ADMIN_PASSWORD = "";

    async function loginAdmin() {
      ADMIN_PASSWORD = document.getElementById("adminPassword").value.trim();
      if (ADMIN_PASSWORD === "") return alert("Enter password");

      // Check connection
      const res = await fetch(`${API_BASE}/books`);
      if (!res.ok) return alert("Cannot connect to backend");

      document.getElementById("loginPanel").classList.add("hidden");
      document.getElementById("adminPanel").classList.remove("hidden");

      refreshAll();
    }

    async function refreshAll() {
      await loadBooks();
      await loadResults();
      await loadVotingStatus();
    }

    // ------------------------------
    // Voting toggle
    // ------------------------------
    async function loadVotingStatus() {
      const res = await fetch(`${API_BASE}/voting_status`);
      const data = await res.json();
      document.getElementById("votingStatusText").textContent = data.voting_open ? "OPEN" : "CLOSED";
    }

    document.getElementById("toggleVotingBtn").addEventListener("click", async () => {
      const current = document.getElementById("votingStatusText").textContent === "OPEN";
      const res = await fetch(`${API_BASE}/admin/toggle_voting`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password: ADMIN_PASSWORD, voting_open: !current })
      });
      const data = await res.json();
      if (res.ok) document.getElementById("votingStatusText").textContent = data.voting_open ? "OPEN" : "CLOSED";
      else alert(data.error || "Failed to toggle voting");
    });

    // ------------------------------
    // Add Book
    // ------------------------------
    async function loadBooks() {
      const res = await fetch(`${API_BASE}/books`);
      const books = await res.json();
      const list = document.getElementById("bookList");
      list.innerHTML = "";
      books.forEach(b => {
        const li = document.createElement("li");
        li.textContent = b.title;
        list.appendChild(li);
      });
    }

    document.getElementById("addBookBtn").addEventListener("click", async () => {
      const title = document.getElementById("newBookTitle").value.trim();
      if (!title) return;
      const res = await fetch(`${API_BASE}/admin/add_book`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password: ADMIN_PASSWORD, title })
      });
      const data = await res.json();
      if (res.ok) {
        document.getElementById("newBookTitle").value = "";
        loadBooks();
      } else alert(data.error || "Failed to add book");
    });

    // ------------------------------
    // Results
    // ------------------------------
    async function loadResults() {
      const res = await fetch(`${API_BASE}/results`);
      const results = await res.json();

      const table = document.getElementById("resultsTable");
      table.innerHTML = "";

      const scoreMap = [];
      for (const id in results) {
        const b = results[id];
        const points = b.votes.reduce((a, v) => a + v.priority, 0);
        scoreMap.push({ title: b.title, points, votes: b.votes });
      }

      // Sort by points descending
      scoreMap.sort((a, b) => b.points - a.points);
      const maxPoints = scoreMap.length ? scoreMap[0].points : 0;

      scoreMap.forEach(row => {
        const tr = document.createElement("tr");
        if (row.points === maxPoints && maxPoints > 0) tr.classList.add("bg-yellow-100");

        const votersList = row.votes.map(v => `${v.name} (${v.priority})`).join(", ");

        tr.innerHTML = `
          <td class="px-3 py-2 border-t">${row.title}</td>
          <td class="px-3 py-2 border-t font-semibold">${row.points}</td>
          <td class="px-3 py-2 border-t text-sm text-gray-600">${votersList || "-"}</td>
        `;
        table.appendChild(tr);
      });
    }

    // ------------------------------
    // Export Votes
    // ------------------------------
    document.getElementById("exportBtn").addEventListener("click", async () => {
      const res = await fetch(`${API_BASE}/results`);
      const data = await res.json();
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const a = document.createElement(
