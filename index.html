<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ“š Book Club Voting</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .draggable { cursor: grab; user-select: none; }
    .dragging { opacity: 0.5; }
    .drop-zone { min-height: 80px; transition: background-color 0.2s; }
    .drop-zone.drag-over { background-color: #dbeafe; }
    .disabled { opacity: 0.4; pointer-events: none; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col items-center justify-start p-8">
  <div class="max-w-3xl w-full bg-white p-6 rounded-2xl shadow-md">
    <h1 class="text-3xl font-bold mb-6 text-center">ğŸ“š Book Club Voting</h1>

    <!-- Voting Form -->
    <div id="voting-section">
      <label class="block font-medium mb-2">Your Name:</label>
      <input id="name" type="text" class="w-full border rounded-lg p-2 mb-4" placeholder="Enter your name">

      <h3 class="text-lg font-semibold mb-2">Available Books</h3>
      <div id="available-books" class="border-2 border-dashed border-gray-300 rounded-lg p-4 min-h-[120px] bg-gray-50 mb-6"></div>

      <div class="grid grid-cols-2 gap-6 mb-6">
        <div>
          <h3 class="font-semibold text-blue-700 mb-2">ğŸ¥‡ First Priority (2 points)</h3>
          <div id="first-priority" class="drop-zone border-2 border-dashed border-blue-300 rounded-lg p-3 bg-blue-50 min-h-[80px]"></div>
        </div>
        <div>
          <h3 class="font-semibold text-green-700 mb-2">ğŸ¥ˆ Second Priority (1 point)</h3>
          <div id="second-priority" class="drop-zone border-2 border-dashed border-green-300 rounded-lg p-3 bg-green-50 min-h-[80px]"></div>
        </div>
      </div>

      <button id="voteBtn"
        class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-semibold transition">
        Submit Vote
      </button>

      <!-- Voter list -->
      <div class="mt-6">
        <h3 class="text-lg font-semibold mb-2">ğŸ—³ï¸ Members who have voted</h3>
        <ul id="voterList" class="list-disc ml-6 text-gray-700"></ul>
      </div>
    </div>

    <!-- Results Section -->
    <div id="results-section" class="hidden mt-8">
      <h2 class="text-xl font-semibold mb-4">ğŸ“Š Voting Results</h2>
      <table class="min-w-full border border-gray-200 rounded-lg text-sm">
        <thead class="bg-gray-100">
          <tr>
            <th class="text-left p-2 border-b">Book</th>
            <th class="text-left p-2 border-b">Points</th>
            <th class="text-left p-2 border-b">Voters (Priority)</th>
          </tr>
        </thead>
        <tbody id="resultsTable"></tbody>
      </table>
    </div>
  </div>

  <script>
    const API = "https://bookbook-1vj9.onrender.com";
    let allBooks = [];

    async function loadConfig() {
      const res = await fetch(`${API}/config`);
      const data = await res.json();

      if (data.voting_open) {
        document.getElementById("voting-section").classList.remove("hidden");
        document.getElementById("results-section").classList.add("hidden");
        loadBooks();
        loadVoters();
      } else {
        document.getElementById("voting-section").classList.add("hidden");
        document.getElementById("results-section").classList.remove("hidden");
        showResults();
      }
    }

    async function loadBooks() {
      const res = await fetch(`${API}/books`);
      allBooks = await res.json();

      const container = document.getElementById("available-books");
      container.innerHTML = "";
      allBooks.forEach(book => container.appendChild(createBookElement(book)));
      setupDragAndDrop();
    }

    async function loadVoters() {
      const res = await fetch(`${API}/voters`);
      const voters = await res.json();
      document.getElementById("voterList").innerHTML =
        voters.map(v => `<li>${v}</li>`).join("");
    }

    function createBookElement(book) {
      const div = document.createElement("div");
      div.className =
        "book-item draggable bg-white border border-gray-300 rounded px-3 py-2 mb-2 cursor-move hover:bg-gray-100 transition";
      div.draggable = true;
      div.textContent = book.title;
      div.dataset.id = book.id;
      return div;
    }

    function setupDragAndDrop() {
      const dropZones = document.querySelectorAll(".drop-zone, #available-books");

      document.querySelectorAll(".draggable").forEach(el => {
        el.addEventListener("dragstart", e => {
          e.dataTransfer.setData("text/plain", e.target.dataset.id);
          el.classList.add("dragging");
        });
        el.addEventListener("dragend", e => el.classList.remove("dragging"));
      });

      dropZones.forEach(zone => {
        zone.addEventListener("dragover", e => {
          e.preventDefault();
          zone.classList.add("drag-over");
        });
        zone.addEventListener("dragleave", () => zone.classList.remove("drag-over"));
        zone.addEventListener("drop", e => {
          e.preventDefault();
          zone.classList.remove("drag-over");
          const bookId = e.dataTransfer.getData("text/plain");
          const draggedEl = document.querySelector(`[data-id='${bookId}']`);
          if (zone.id !== "available-books" && zone.children.length > 0) {
            document.getElementById("available-books").appendChild(zone.children[0]);
          }
          zone.appendChild(draggedEl);
          updateDisabledBooks();
        });
      });
    }

    function updateDisabledBooks() {
      const chosenIds = [
        document.querySelector("#first-priority .book-item")?.dataset.id,
        document.querySelector("#second-priority .book-item")?.dataset.id
      ].filter(Boolean);

      document.querySelectorAll("#available-books .book-item").forEach(el => {
        el.classList.toggle("disabled", chosenIds.includes(el.dataset.id));
      });
    }

    document.getElementById("voteBtn").addEventListener("click", async () => {
      const name = document.getElementById("name").value.trim();
      const first = document.querySelector("#first-priority .book-item")?.dataset.id;
      const second = document.querySelector("#second-priority .book-item")?.dataset.id;

      if (!name || !first || !second) {
        alert("Please enter your name and drag two books into the slots.");
        return;
      }

      const res = await fetch(`${API}/vote`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, first_choice: first, second_choice: second })
      });

      if (res.ok) {
        alert("âœ… Vote submitted!");
        loadVoters();
      } else {
        alert("âŒ Error submitting vote.");
      }
    });

    async function showResults() {
      const [votesRes, booksRes] = await Promise.all([
        fetch(`${API}/votes`),
        fetch(`${API}/books`)
      ]);
      const votes = await votesRes.json();
      const books = await booksRes.json();

      const points = {};
      const voters = {};
      const bookMap = {};
      books.forEach(b => (bookMap[b.id.toString()] = b.title));

      votes.forEach(vote => {
        const f = vote.first_choice.toString();
        const s = vote.second_choice.toString();
        if (!points[f]) points[f] = 0;
        if (!points[s]) points[s] = 0;
        points[f] += 2;
        points[s] += 1;

        if (!voters[f]) voters[f] = [];
        if (!voters[s]) voters[s] = [];
        voters[f].push(`${vote.name} (2)`);
        voters[s].push(`${vote.name} (1)`);
      });

      const sorted = Object.keys(points)
        .map(id => ({
          book: bookMap[id] || "Unknown",
          pts: points[id],
          voters: (voters[id] || []).join(", ")
        }))
        .sort((a, b) => b.pts - a.pts);

      const maxPts = sorted.length ? sorted[0].pts : 0;
      const tbody = document.getElementById("resultsTable");
      tbody.innerHTML = "";

      sorted.forEach(row => {
        const tr = document.createElement("tr");
        tr.className = `${row.pts === maxPts ? "bg-yellow-100 font-semibold" : ""}`;
        tr.innerHTML = `
          <td class="border-b p-2">${row.book}</td>
          <td class="border-b p-2">${row.pts}</td>
          <td class="border-b p-2">${row.voters}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    loadConfig();
  </script>
</body>
</html>
